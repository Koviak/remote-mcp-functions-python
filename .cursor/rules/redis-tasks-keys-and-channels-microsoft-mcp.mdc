---
description: "TIER 3 - Domain Specific: Microsoft MCP Server Redis patterns for Planner sync. Specialized keys, schemas, and channels for MS-MCP task synchronization. Use this when working with Microsoft 365 integration and Planner sync."
alwaysApply: false
---
## ðŸŽ¯ WHEN TO USE THIS FILE
- Working with Microsoft 365 Planner integration
- Implementing or debugging Planner â†” Annika task sync
- Understanding MS-MCP specific Redis keys and schemas
- Setting up webhook handlers for Planner notifications
- Debugging task ID mapping between systems

## ðŸ“š FILE HIERARCHY
- **Prerequisites**: 
  1. [redis-master-manager.mdc](mdc:.cursor/rules/redis-master-manager.mdc) - Connection patterns
  2. [redis-component-keys-map.mdc](mdc:.cursor/rules/redis-component-keys-map.mdc) - General key patterns
- **This File**: MS-MCP specific patterns and schemas
- **Related**: 
  - [planner-sync-master.mdc](mdc:.cursor/rules/planner-sync-master.mdc) - Planner sync architecture
  - [planner-annika-sync-fixes-and-trace.mdc](mdc:.cursor/rules/planner-annika-sync-fixes-and-trace.mdc) - Sync fixes

## ðŸ”— KEY PRINCIPLES
- **Authoritative Storage**: `annika:tasks:{id}` is single source of truth
- **ID Mapping**: Forward/reverse maps determine create vs. update
- **Webhook-Driven**: Real-time sync via Graph webhooks
- **Schema Flexibility**: Supports both agent and adapter field naming

---

## Redis task-related keys and channels

Use these canonical keys and channels when storing, caching, or syncing tasks with Microsoft Planner. Links reference the exact implementation sites.

### Primary task storage (agents)
- `annika:tasks:{id}` â€” primary agent task storage (authoritative; no expiry)
  - Creation: see `create_agent_task_http` in [src/http_endpoints.py](mdc:src/http_endpoints.py)
    - Writes task JSON: `redis_client.set(f"annika:tasks:{task['id']}", json.dumps(task))`
  - Docs references: [src/Documentation/Planner_Agent_Task_Creation_Guide.md](mdc:src/Documentation/Planner_Agent_Task_Creation_Guide.md), [src/Documentation/Redis_First_Architecture_Summary.md](mdc:src/Documentation/Redis_First_Architecture_Summary.md)

#### Schema (authoritative Annika task object)
```json
{
  "type": "object",
  "required": ["id", "title", "planId"],
  "properties": {
    "id": {"type": "string", "description": "Unique task id, e.g. agent-task-<timestamp> or planner-<id>"},
    "title": {"type": "string"},
    "planId": {"type": "string"},
    "bucketId": {"type": ["string", "null"], "description": "Optional bucket id"},
    "assignedTo": {"type": "array", "items": {"type": "string"}, "description": "User IDs for assignment (agent creation path)"},
    "assigned_to": {"type": ["string", "null"], "description": "Display name mapping (adapter path)"},
    "dueDate": {"type": ["string", "null"], "description": "YYYY-MM-DD (agent path)"},
    "due_date": {"type": ["string", "null"], "description": "YYYY-MM-DD (adapter path)"},
    "percentComplete": {"type": ["number", "integer"], "minimum": 0, "maximum": 100},
    "percent_complete": {"type": "number", "minimum": 0, "maximum": 1},
    "status": {"type": ["string", "null"], "enum": ["not_started", "in_progress", "completed", null]},
    "priority": {"type": ["string", "integer", "null"], "description": "Adapter maps Graph priority int â†’ enum"},
    "description": {"type": ["string", "null"]},
    "notes": {"type": ["string", "null"]},
    "labels": {"type": "array", "items": {"type": "string"}},
    "checklist_items": {"type": "array", "items": {"type": "object"}},
    "dependencies": {"type": "array", "items": {"type": "string"}},
    "blocking": {"type": "array", "items": {"type": "string"}},
    "attachments": {"type": "array", "items": {"type": "object"}},
    "notifications": {"type": "array", "items": {"type": "object"}},
    "bucket_id": {"type": ["string", "null"], "description": "Adapter path field name"},
    "order": {"type": ["string", "number", "null"]},
    "createdBy": {"type": ["string", "null"]},
    "createdAt": {"type": ["string", "null"], "description": "ISO timestamp from agent create path"},
    "created_at": {"type": ["string", "null"], "description": "ISO timestamp from adapter path"},
    "updated_at": {"type": ["string", "null"]},
    "completed_at": {"type": ["string", "null"]},
    "source": {"type": ["string", "null"], "description": "'agent' or 'planner'"},
    "external_id": {"type": ["string", "null"], "description": "Planner task id when source is planner"}
  },
  "additionalProperties": true
}
```

### Microsoft Graph task metadata cache
- `annika:graph:tasks:{task_id}` â€” cached Planner/Graph task metadata (persists; no TTL by design)
  - Constants: `REDIS_TASK_KEY` in [src/graph_metadata_manager.py](mdc:src/graph_metadata_manager.py)
  - Used by metadata HTTP mapping: [src/http_endpoints.py](mdc:src/http_endpoints.py) (resource â†’ key mapping)

#### Schema (subset of Microsoft Graph plannerTask + details)
```json
{
  "type": "object",
  "required": ["id", "title", "planId"],
  "properties": {
    "id": {"type": "string"},
    "title": {"type": "string"},
    "planId": {"type": "string"},
    "bucketId": {"type": ["string", "null"]},
    "assignments": {"type": "object"},
    "percentComplete": {"type": "integer", "minimum": 0, "maximum": 100},
    "startDateTime": {"type": ["string", "null"]},
    "dueDateTime": {"type": ["string", "null"]},
    "createdDateTime": {"type": ["string", "null"]},
    "completedDateTime": {"type": ["string", "null"]},
    "orderHint": {"type": ["string", "null"]},
    "priority": {"type": ["integer", "null"]},
    "hasDescription": {"type": ["boolean", "null"]},
    "previewType": {"type": ["string", "null"]},
    "details": {"type": ["object", "null"], "description": "Response from /planner/tasks/{id}/details"}
  },
  "additionalProperties": true
}
```

### Temporary Planner task cache
- `annika:planner:tasks:{task_id}` â€” temporary cache (TTL ~1 hour)
  - Set with `setex(...)` in [src/http_endpoints.py](mdc:src/http_endpoints.py)

#### Schema
Same as the Microsoft Graph task cache schema above (planId/title/etc.), often a direct snapshot from Graph responses.

### Task lists (JSON documents)
- `annika:conscious_state` â€” global state JSON containing `task_lists` (mirror; do not gate sync logic)
  - JSON path: `$.task_lists.*.tasks[*]`
  - Read example: [src/annika_task_adapter.py](mdc:src/annika_task_adapter.py)

- `annika:consciousness:{conversation_id}:components:tasks` â€” conversation-specific task list JSON
  - JSON path: `$.active_conversation.tasks[*]`
  - Discovery/read example: [src/annika_task_adapter.py](mdc:src/annika_task_adapter.py)

#### Schema (task lists containers)
```json
{
  "type": "object",
  "properties": {
    "task_lists": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "buckets": {"type": ["array", "null"], "items": {"type": "object"}},
          "tasks": {"type": "array", "items": {"$ref": "#/$defs/AnnikaTask"}},
          "last_updated": {"type": ["string", "null"]}
        },
        "additionalProperties": true
      }
    },
    "active_conversation": {
      "type": "object",
      "properties": {
        "tasks": {"type": "array", "items": {"$ref": "#/$defs/AnnikaTask"}},
        "last_updated": {"type": ["string", "null"]}
      },
      "additionalProperties": true
    }
  },
  "$defs": {
    "AnnikaTask": {
      "type": "object",
      "required": ["id", "title"],
      "properties": {
        "id": {"type": "string"},
        "title": {"type": "string"}
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}
```

### Pub/Sub channels related to tasks
- `annika:tasks:updates` â€” publishes task create/update notifications (MSâ€‘MCP fastâ€‘path: parse `task_id`, fetch that task only)
  - Published in: [src/http_endpoints.py](mdc:src/http_endpoints.py)
  - Consumed/subscribed in: [src/planner_sync_service_v4.py](mdc:src/planner_sync_service_v4.py), [src/planner_sync_service_v5.py](mdc:src/planner_sync_service_v5.py)

Payload schema (typical):
```json
{
  "type": "object",
  "required": ["action", "task"],
  "properties": {
    "action": {"type": "string", "enum": ["created", "updated", "deleted", "task_synced"]},
    "task": {"$ref": "#/$defs/AnnikaTask"},
    "source": {"type": ["string", "null"], "enum": ["agent", "planner", null]}
  },
  "$defs": {
    "AnnikaTask": {"type": "object", "additionalProperties": true}
  },
  "additionalProperties": true
}
```

- `annika:tasks:sync` â€” documented channel for sync confirmations (see docs)
  - Docs references: [src/Documentation/Planner_Agent_Task_Creation_Guide.md](mdc:src/Documentation/Planner_Agent_Task_Creation_Guide.md), [src/Documentation/Redis_First_Architecture_Summary.md](mdc:src/Documentation/Redis_First_Architecture_Summary.md)

- `annika:planner:webhook` â€” subscribed by v5 sync service for webhook-driven events
  - Subscription: [src/planner_sync_service_v5.py](mdc:src/planner_sync_service_v5.py)

### Related metadata keys for context
- `annika:graph:users:{user_id}`
- `annika:graph:groups:{group_id}`
- `annika:graph:plans:{plan_id}`
- `annika:graph:buckets:{bucket_id}`
  - Defined in: [src/graph_metadata_manager.py](mdc:src/graph_metadata_manager.py)

### Quick lookup mapping (HTTP metadata endpoint)
The metadata HTTP handler maps `type` â†’ Redis key pattern:
- `user` â†’ `annika:graph:users:{id}`
- `group` â†’ `annika:graph:groups:{id}`
- `plan` â†’ `annika:graph:plans:{id}`
- `task` â†’ `annika:graph:tasks:{id}`

See mapping in: [src/http_endpoints.py](mdc:src/http_endpoints.py)

### Notes
## Crossâ€‘Links
- Planner Sync Master: [planner-sync-master.mdc](mdc:.cursor/rules/planner-sync-master.mdc)
- Redis Keys (canonical): [redis-component-keys-map.mdc](mdc:.cursor/rules/redis-component-keys-map.mdc)
- System Architecture: [system-architecture.mdc](mdc:.cursor/rules/system-architecture.mdc)
- `annika:tasks:{id}` is authoritative; Annikaâ†’Planner create vs update is determined solely by ID maps, not list contents.
- Planner/Graph task metadata (`annika:graph:tasks:{task_id}`) is a cache for fast reads and can be refreshed by sync/metadata services.
- Use RedisJSON for mirrors (e.g., `annika:conscious_state`, perâ€‘conversation lists); store perâ€‘task objects as string JSON unless JSON ops are required.

## Additional Redis entries and schemas

### Token storage
- `{REDIS_NAMESPACE}tokens:agent:{scope}`
- `{REDIS_NAMESPACE}tokens:user:{user_id}:{scope}`
- `{REDIS_NAMESPACE}tokens:active` (set of keys)
- Source: [src/Documentation/REDIS_TOKEN_STORAGE_IMPLEMENTATION.md](mdc:src/Documentation/REDIS_TOKEN_STORAGE_IMPLEMENTATION.md), [src/mcp_redis_config.py](mdc:src/mcp_redis_config.py)

Schema (value for tokens:agent / tokens:user):
```json
{
  "type": "object",
  "required": ["token", "expires_on", "scope", "stored_at"],
  "properties": {
    "token": {"type": "string"},
    "expires_on": {"type": "integer"},
    "scope": {"type": "string"},
    "stored_at": {"type": "integer"},
    "refresh_count": {"type": "integer"},
    "user_id": {"type": ["string", "null"]},
    "metadata": {"type": ["object", "null"]}
  },
  "additionalProperties": true
}
```

### Planner sync service keys
- `annika:planner:id_map:{id}` â€” bidirectional Annika â†” Planner id mappings
- `annika:planner:etag:{planner_id}` â€” ETag per Planner task
- `annika:sync:log` â€” list of sync log entries
- `annika:sync:pending` â€” list of queued operations
- `annika:sync:failed` â€” list of failed operations
- `annika:sync:webhook_status` â€” hash of webhook name â†’ subscription id
- `annika:sync:health` â€” last health metrics snapshot
- `annika:sync:last_upload:{annika_id}` â€” ISO timestamp of last upload for an Annika task
- Source: [src/planner_sync_service_v5.py](mdc:src/planner_sync_service_v5.py)

Schemas:
- Id map values: string
```json
{"type": "string"}
```
- ETag values: string
```json
{"type": "string"}
```
- Sync log entry (`annika:sync:log` list items):
```json
{
  "type": "object",
  "required": ["timestamp", "operation", "status"],
  "properties": {
    "timestamp": {"type": "string"},
    "operation": {"type": "string"},
    "annika_id": {"type": ["string", "null"]},
    "planner_id": {"type": ["string", "null"]},
    "status": {"type": "string"},
    "error": {"type": ["string", "null"]},
    "conflict_resolution": {"type": ["string", "null"]}
  },
  "additionalProperties": true
}
```
- Pending/failed operations list items:
```json
{
  "type": "object",
  "required": ["type", "task_id", "timestamp"],
  "properties": {
    "type": {"type": "string"},
    "task_id": {"type": "string"},
    "timestamp": {"type": "string"}
  },
  "additionalProperties": true
}
```
- Webhook status hash (field â†’ subscription id): values are string
```json
{"type": "string"}
```
- Sync health snapshot (`annika:sync:health`):
```json
{
  "type": "object",
  "required": ["timestamp", "processed_tasks", "pending_uploads", "failed_operations"],
  "properties": {
    "timestamp": {"type": "string"},
    "processed_tasks": {"type": "integer"},
    "pending_uploads": {"type": "integer"},
    "failed_operations": {"type": "integer"},
    "rate_limit_status": {"type": "string"},
    "webhook_status": {"type": "integer"},
    "consecutive_failures": {"type": "integer"}
  },
  "additionalProperties": true
}
```
- Last upload timestamp value: string (ISO)
```json
{"type": "string"}
```

### Teams notifications and history
- Channels:
  - `annika:teams:chat_messages`
  - `annika:teams:chats`
  - `annika:teams:channel_messages`
  - `annika:teams:channels`
- History lists:
  - `annika:teams:chat_messages:history`
  - `annika:teams:chats:history`
  - `annika:teams:channel_messages:history`
  - `annika:teams:channels:history`
- Source: [src/planner_sync_service_v5.py](mdc:src/planner_sync_service_v5.py)

Payload schemas:
- Chat message notification:
```json
{
  "type": "object",
  "required": ["timestamp", "type", "change_type", "chat_id", "message_id"],
  "properties": {
    "timestamp": {"type": "string"},
    "type": {"const": "teams_chat_message"},
    "change_type": {"type": "string"},
    "chat_id": {"type": "string"},
    "message_id": {"type": "string"},
    "client_state": {"type": ["string", "null"]},
    "resource": {"type": ["string", "null"]},
    "notification_id": {"type": ["string", "null"]},
    "raw_notification": {"type": ["object", "null"]}
  },
  "additionalProperties": true
}
```
- Chat notification:
```json
{
  "type": "object",
  "required": ["timestamp", "type", "change_type", "chat_id"],
  "properties": {
    "timestamp": {"type": "string"},
    "type": {"const": "teams_chat"},
    "change_type": {"type": "string"},
    "chat_id": {"type": "string"},
    "client_state": {"type": ["string", "null"]},
    "notification_id": {"type": ["string", "null"]},
    "raw_notification": {"type": ["object", "null"]}
  },
  "additionalProperties": true
}
```
- Channel message notification:
```json
{
  "type": "object",
  "required": ["timestamp", "type", "change_type", "team_id", "channel_id", "message_id"],
  "properties": {
    "timestamp": {"type": "string"},
    "type": {"const": "teams_channel_message"},
    "change_type": {"type": "string"},
    "team_id": {"type": "string"},
    "channel_id": {"type": "string"},
    "message_id": {"type": "string"},
    "client_state": {"type": ["string", "null"]},
    "resource": {"type": ["string", "null"]},
    "notification_id": {"type": ["string", "null"]},
    "raw_notification": {"type": ["object", "null"]}
  },
  "additionalProperties": true
}
```
- Channel notification:
```json
{
  "type": "object",
  "required": ["timestamp", "type", "change_type", "channel_id"],
  "properties": {
    "timestamp": {"type": "string"},
    "type": {"const": "teams_channel"},
    "change_type": {"type": "string"},
    "channel_id": {"type": "string"},
    "client_state": {"type": ["string", "null"]},
    "notification_id": {"type": ["string", "null"]},
    "raw_notification": {"type": ["object", "null"]}
  },
  "additionalProperties": true
}
```

### Chat subscriptions
- `annika:chat_subscriptions:{chat_id}` â€” hash: subscription state
- `annika:chat_subscriptions:global` â€” hash: global subscription state
- Source: [src/chat_subscription_manager.py](mdc:src/chat_subscription_manager.py)

Schema (hash fields â†’ string values):
```json
{
  "type": "object",
  "properties": {
    "subscription_id": {"type": "string"},
    "created_at": {"type": "string"},
    "expires_at": {"type": "string"},
    "status": {"type": "string"}
  },
  "additionalProperties": true
}
```

### Graph notifications channels
- `annika:notifications:user`
- `annika:notifications:groups`
- `annika:notifications:planner`
- `annika:notifications:general`
- Source: [src/http_endpoints.py](mdc:src/http_endpoints.py)

Payload schema:
```json
{
  "type": "object",
  "required": ["type", "resource", "changeType"],
  "properties": {
    "type": {"const": "graph_notification"},
    "resource": {"type": "string"},
    "changeType": {"type": "string"},
    "resourceData": {"type": ["object", "null"]},
    "subscriptionId": {"type": ["string", "null"]},
    "timestamp": {"type": ["string", "null"]}
  },
  "additionalProperties": true
}
```

### Graph caches (metadata)
- `annika:graph:users:{user_id}`
- `annika:graph:groups:{group_id}`
- `annika:graph:plans:{plan_id}`
- `annika:graph:tasks:{task_id}` (schema defined above)
- `annika:graph:buckets:{bucket_id}`
- Source: [src/graph_metadata_manager.py](mdc:src/graph_metadata_manager.py)

Schemas: stored as raw Graph JSON objects for each resource; allow additionalProperties.

### Config values
- `annika:config:default_plan_id` â€” string plan id used by sync service if set
- Source: [src/planner_sync_service_v5.py](mdc:src/planner_sync_service_v5.py)

Schema:
```json
{"type": "string"}
```

